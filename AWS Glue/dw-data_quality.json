{
	"jobConfig": {
		"name": "dw-data_quality",
		"description": "",
		"role": "arn:aws:iam::886452736724:role/AWSGlueRDSExecutionRole",
		"command": "pythonshell",
		"version": "3.0",
		"runtime": null,
		"workerType": null,
		"numberOfWorkers": null,
		"maxCapacity": 0.0625,
		"jobRunQueuingEnabled": false,
		"maxRetries": 0,
		"timeout": 2880,
		"maxConcurrentRuns": 1,
		"security": "none",
		"scriptName": "dw-data_quality.py",
		"scriptLocation": "s3://aws-glue-assets-886452736724-us-east-1/scripts/",
		"language": "python-3.9",
		"spark": false,
		"jobParameters": [
			{
				"key": "--PGDATABASE",
				"value": "datalakeproduction1",
				"existing": false
			},
			{
				"key": "--PGHOST",
				"value": "datalakeproduction1.cynamiwwmnme.us-east-1.rds.amazonaws.com",
				"existing": false
			},
			{
				"key": "--PGPASSWORD",
				"value": "************",
				"existing": false
			},
			{
				"key": "--PGPORT",
				"value": "************",
				"existing": false
			},
			{
				"key": "--PGUSER",
				"value": "************",
				"existing": false
			}
		],
		"tags": [],
		"jobMode": "DEVELOPER_MODE",
		"createdOn": "2025-12-07T14:36:08.735Z",
		"developerMode": true,
		"connectionsList": [],
		"temporaryDirectory": "s3://aws-glue-assets-886452736724-us-east-1/temporary/",
		"glueHiveMetastore": true,
		"etlAutoTuning": false,
		"observabilityMetrics": false,
		"pythonShellPrebuiltLibraryOption": "analytics",
		"flexExecution": false,
		"minFlexWorkers": null,
		"maintenanceWindow": null
	},
	"hasBeenSaved": false,
	"usageProfileName": null,
	"script": "import pg8000\nimport ssl\nimport sys\nfrom awsglue.utils import getResolvedOptions\n\n# SSL context (same as other jobs)\nssl_ctx = ssl.create_default_context()\nssl_ctx.check_hostname = False\nssl_ctx.verify_mode = ssl.CERT_NONE\n\n\ndef run_statements(cursor, statements):\n    for s in statements:\n        print(f\"Running statement:\\n{s[:120]}.\")\n        cursor.execute(s)\n\n\ndef dq_check(cur, name, check_type, table_name, sql,\n             severity=\"ERROR\", expected=0, comparison=\"==\"):\n    \"\"\"\n    Execute sql (must return one numeric value), compare with expected,\n    log into dw.data_quality_log, and optionally raise if failed and severity=ERROR.\n    \"\"\"\n    print(f\"Running DQ check: {name}\")\n    cur.execute(sql)\n    row = cur.fetchone()\n    value = row[0] if row is not None else None\n\n    # Handle NULL result: treat as failure\n    passed = False\n    if value is not None:\n        if comparison == \"==\":\n            passed = (value == expected)\n        elif comparison == \">\":\n            passed = (value > expected)\n        elif comparison == \">=\":\n            passed = (value >= expected)\n        elif comparison == \"<\":\n            passed = (value < expected)\n        elif comparison == \"<=\":\n            passed = (value <= expected)\n\n    status = \"PASSED\" if passed else \"FAILED\"\n\n    insert_log_sql = \"\"\"\n        INSERT INTO dw.data_quality_log (\n            check_name,\n            check_type,\n            table_name,\n            details,\n            severity,\n            status,\n            observed_value,\n            expected_value\n        )\n        VALUES (%s, %s, %s, %s, %s, %s, %s, %s);\n    \"\"\"\n    cur.execute(\n        insert_log_sql,\n        (\n            name,\n            check_type,\n            table_name,\n            sql,\n            severity,\n            status,\n            float(value) if value is not None else None,\n            float(expected) if expected is not None else None,\n        ),\n    )\n\n    if not passed and severity == \"ERROR\":\n        raise RuntimeError(\n            f\"Data quality check failed: {name} \"\n            f\"(value={value}, expected {comparison} {expected})\"\n        )\n\n\ndef main():\n    # Read Glue job parameters\n    args = getResolvedOptions(\n        sys.argv,\n        [\"PGHOST\", \"PGPORT\", \"PGDATABASE\", \"PGUSER\", \"PGPASSWORD\"],\n    )\n\n    conn = pg8000.connect(\n        host=args[\"PGHOST\"],\n        database=args[\"PGDATABASE\"],\n        user=args[\"PGUSER\"],\n        password=args[\"PGPASSWORD\"],\n        port=int(args[\"PGPORT\"]),\n        ssl_context=ssl_ctx,\n    )\n    cur = conn.cursor()\n\n    # 0) Ensure DQ log table exists\n    create_log_sql = \"\"\"\n    CREATE TABLE IF NOT EXISTS dw.data_quality_log (\n        id             bigserial PRIMARY KEY,\n        check_name     text        NOT NULL,\n        check_type     text        NOT NULL,\n        table_name     text        NOT NULL,\n        details        text,\n        severity       text        NOT NULL,  -- ERROR or WARNING\n        status         text        NOT NULL,  -- PASSED or FAILED\n        observed_value numeric,\n        expected_value numeric,\n        created_at     timestamptz NOT NULL DEFAULT now()\n    );\n    \"\"\"\n    cur.execute(create_log_sql)\n\n    try:\n        # ------------------------------------------------------------------\n        # 1) Basic row-count checks on staging\n        # ------------------------------------------------------------------\n        dq_check(\n            cur,\n            name=\"stg_air_quality_not_empty\",\n            check_type=\"row_count\",\n            table_name=\"public.stg_air_quality\",\n            sql=\"SELECT COUNT(*) FROM public.stg_air_quality\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\">\",\n        )\n\n        dq_check(\n            cur,\n            name=\"stg_earthquakes_not_empty\",\n            check_type=\"row_count\",\n            table_name=\"public.stg_earthquakes\",\n            sql=\"SELECT COUNT(*) FROM public.stg_earthquakes\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\">\",\n        )\n\n        dq_check(\n            cur,\n            name=\"stg_fires_not_empty\",\n            check_type=\"row_count\",\n            table_name=\"public.stg_fires\",\n            sql=\"SELECT COUNT(*) FROM public.stg_fires\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\">\",\n        )\n\n        # ------------------------------------------------------------------\n        # 2) Staging range / validity checks\n        # ------------------------------------------------------------------\n\n        # 2.1 Air quality: coordinates and AQI ranges\n        dq_check(\n            cur,\n            name=\"stg_air_quality_invalid_coords\",\n            check_type=\"range\",\n            table_name=\"public.stg_air_quality\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM public.stg_air_quality\n                WHERE latitude  NOT BETWEEN -90 AND 90\n                   OR longitude NOT BETWEEN -180 AND 180;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        dq_check(\n            cur,\n            name=\"stg_air_quality_invalid_aqi\",\n            check_type=\"range\",\n            table_name=\"public.stg_air_quality\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM public.stg_air_quality\n                WHERE pollution_aqius < 0\n                   OR pollution_aqius > 500\n                   OR pollution_aqicn < 0\n                   OR pollution_aqicn > 500;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        dq_check(\n            cur,\n            name=\"stg_air_quality_null_pollution_ts\",\n            check_type=\"nulls\",\n            table_name=\"public.stg_air_quality\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM public.stg_air_quality\n                WHERE pollution_ts IS NULL;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        # 2.2 Earthquakes: coordinates, magnitude >= 0, depth >= 0, event_time not null\n        dq_check(\n            cur,\n            name=\"stg_earthquakes_invalid_coords\",\n            check_type=\"range\",\n            table_name=\"public.stg_earthquakes\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM public.stg_earthquakes\n                WHERE latitude  NOT BETWEEN -90 AND 90\n                   OR longitude NOT BETWEEN -180 AND 180;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        dq_check(\n            cur,\n            name=\"stg_earthquakes_negative_magnitude\",\n            check_type=\"range\",\n            table_name=\"public.stg_earthquakes\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM public.stg_earthquakes\n                WHERE magnitude < 0;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        dq_check(\n            cur,\n            name=\"stg_earthquakes_negative_depth\",\n            check_type=\"range\",\n            table_name=\"public.stg_earthquakes\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM public.stg_earthquakes\n                WHERE depth < 0;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        dq_check(\n            cur,\n            name=\"stg_earthquakes_null_event_time\",\n            check_type=\"nulls\",\n            table_name=\"public.stg_earthquakes\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM public.stg_earthquakes\n                WHERE event_time IS NULL;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        # 2.3 Fires: coordinates, FRP >= 0, acq_ts not null\n        dq_check(\n            cur,\n            name=\"stg_fires_invalid_coords\",\n            check_type=\"range\",\n            table_name=\"public.stg_fires\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM public.stg_fires\n                WHERE latitude  NOT BETWEEN -90 AND 90\n                   OR longitude NOT BETWEEN -180 AND 180;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        dq_check(\n            cur,\n            name=\"stg_fires_negative_frp\",\n            check_type=\"range\",\n            table_name=\"public.stg_fires\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM public.stg_fires\n                WHERE frp < 0;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        dq_check(\n            cur,\n            name=\"stg_fires_null_acq_ts\",\n            check_type=\"nulls\",\n            table_name=\"public.stg_fires\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM public.stg_fires\n                WHERE acq_ts IS NULL;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        # ------------------------------------------------------------------\n        # 3) Fact vs staging count comparisons (sanity checks)\n        #    We expect fact rows <= staging rows (because of rejects/joins).\n        # ------------------------------------------------------------------\n        def get_single_count(sql):\n            cur.execute(sql)\n            return cur.fetchone()[0]\n\n        # Air quality\n        stg_aq_cnt = get_single_count(\n            \"SELECT COUNT(*) FROM public.stg_air_quality;\"\n        )\n        fact_aq_cnt = get_single_count(\n            \"SELECT COUNT(*) FROM dw.fact_air_quality;\"\n        )\n        dq_check(\n            cur,\n            name=\"fact_air_quality_not_more_than_staging\",\n            check_type=\"row_count\",\n            table_name=\"dw.fact_air_quality\",\n            sql=f\"SELECT {fact_aq_cnt};\",\n            severity=\"WARNING\",\n            expected=stg_aq_cnt,\n            comparison=\"<=\",\n        )\n\n        # Earthquakes\n        stg_eq_cnt = get_single_count(\n            \"SELECT COUNT(*) FROM public.stg_earthquakes;\"\n        )\n        fact_eq_cnt = get_single_count(\n            \"SELECT COUNT(*) FROM dw.fact_earthquake;\"\n        )\n        dq_check(\n            cur,\n            name=\"fact_earthquake_not_more_than_staging\",\n            check_type=\"row_count\",\n            table_name=\"dw.fact_earthquake\",\n            sql=f\"SELECT {fact_eq_cnt};\",\n            severity=\"WARNING\",\n            expected=stg_eq_cnt,\n            comparison=\"<=\",\n        )\n\n        # Fires\n        stg_fire_cnt = get_single_count(\n            \"SELECT COUNT(*) FROM public.stg_fires;\"\n        )\n        fact_fire_cnt = get_single_count(\n            \"SELECT COUNT(*) FROM dw.fact_fire_detection;\"\n        )\n        dq_check(\n            cur,\n            name=\"fact_fire_not_more_than_staging\",\n            check_type=\"row_count\",\n            table_name=\"dw.fact_fire_detection\",\n            sql=f\"SELECT {fact_fire_cnt};\",\n            severity=\"WARNING\",\n            expected=stg_fire_cnt,\n            comparison=\"<=\",\n        )\n\n        # ------------------------------------------------------------------\n        # 4) DW foreign key / referential integrity checks\n        # ------------------------------------------------------------------\n\n        # 4.1 Nulls in foreign keys\n        dq_check(\n            cur,\n            name=\"fact_air_quality_null_location_key\",\n            check_type=\"nulls\",\n            table_name=\"dw.fact_air_quality\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM dw.fact_air_quality\n                WHERE location_key IS NULL;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        dq_check(\n            cur,\n            name=\"fact_air_quality_null_date_key\",\n            check_type=\"nulls\",\n            table_name=\"dw.fact_air_quality\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM dw.fact_air_quality\n                WHERE date_key IS NULL;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        dq_check(\n            cur,\n            name=\"fact_earthquake_null_location_key\",\n            check_type=\"nulls\",\n            table_name=\"dw.fact_earthquake\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM dw.fact_earthquake\n                WHERE location_key IS NULL;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        dq_check(\n            cur,\n            name=\"fact_earthquake_null_date_key\",\n            check_type=\"nulls\",\n            table_name=\"dw.fact_earthquake\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM dw.fact_earthquake\n                WHERE date_key IS NULL;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        dq_check(\n            cur,\n            name=\"fact_fire_null_location_key\",\n            check_type=\"nulls\",\n            table_name=\"dw.fact_fire_detection\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM dw.fact_fire_detection\n                WHERE location_key IS NULL;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        dq_check(\n            cur,\n            name=\"fact_fire_null_date_key\",\n            check_type=\"nulls\",\n            table_name=\"dw.fact_fire_detection\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM dw.fact_fire_detection\n                WHERE date_key IS NULL;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        # 4.2 Check that all date_key values exist in dim_date\n        dq_check(\n            cur,\n            name=\"fact_air_quality_date_key_in_dim_date\",\n            check_type=\"referential_integrity\",\n            table_name=\"dw.fact_air_quality\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM dw.fact_air_quality f\n                LEFT JOIN dw.dim_date d\n                       ON f.date_key = d.date_key\n                WHERE d.date_key IS NULL;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        dq_check(\n            cur,\n            name=\"fact_earthquake_date_key_in_dim_date\",\n            check_type=\"referential_integrity\",\n            table_name=\"dw.fact_earthquake\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM dw.fact_earthquake f\n                LEFT JOIN dw.dim_date d\n                       ON f.date_key = d.date_key\n                WHERE d.date_key IS NULL;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        dq_check(\n            cur,\n            name=\"fact_fire_date_key_in_dim_date\",\n            check_type=\"referential_integrity\",\n            table_name=\"dw.fact_fire_detection\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM dw.fact_fire_detection f\n                LEFT JOIN dw.dim_date d\n                       ON f.date_key = d.date_key\n                WHERE d.date_key IS NULL;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        # 4.3 Check that all location_key values exist in dim_location\n        dq_check(\n            cur,\n            name=\"fact_air_quality_location_key_in_dim_location\",\n            check_type=\"referential_integrity\",\n            table_name=\"dw.fact_air_quality\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM dw.fact_air_quality f\n                LEFT JOIN dw.dim_location l\n                       ON f.location_key = l.location_key\n                WHERE l.location_key IS NULL;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        dq_check(\n            cur,\n            name=\"fact_earthquake_location_key_in_dim_location\",\n            check_type=\"referential_integrity\",\n            table_name=\"dw.fact_earthquake\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM dw.fact_earthquake f\n                LEFT JOIN dw.dim_location l\n                       ON f.location_key = l.location_key\n                WHERE l.location_key IS NULL;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        dq_check(\n            cur,\n            name=\"fact_fire_location_key_in_dim_location\",\n            check_type=\"referential_integrity\",\n            table_name=\"dw.fact_fire_detection\",\n            sql=\"\"\"\n                SELECT COUNT(*)\n                FROM dw.fact_fire_detection f\n                LEFT JOIN dw.dim_location l\n                       ON f.location_key = l.location_key\n                WHERE l.location_key IS NULL;\n            \"\"\",\n            severity=\"ERROR\",\n            expected=0,\n            comparison=\"==\",\n        )\n\n        conn.commit()\n        print(\"Data quality checks completed successfully.\")\n\n    except Exception as e:\n        conn.rollback()\n        print(\"Error during data quality checks:\", e)\n        raise\n    finally:\n        cur.close()\n        conn.close()\n\n\nif __name__ == \"__main__\":\n    main()\n"
}
